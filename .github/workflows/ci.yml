name: CI

on:
  push:
    branches: [master]
  pull_request:

env:
  UNITTEST_SHUFFLE: 1
  UNITTEST_RANDOM_SEED: random
  UNITTEST_THREADS: 1
  UNITTEST_XML: 1
  UNITTEST_PROGRESS: 1

jobs:
  Sanitizer:
    strategy:
      matrix:
        sanitizer: [address, thread]
        os: [Ubuntu, macOS]
        buildType: [Debug, Release]
    runs-on: ${{matrix.os}}-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Set up Clang 9
      if: runner.os == 'Linux'
      run: |
        sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang-9 100
        sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++-9 100

    - name: Install dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get install -y \
            libprocps-dev

    - name: Create build folder
      run: mkdir build

    - name: Build
      working-directory: ./build
      shell: bash
      run: |
        cmake .. -DCMAKE_BUILD_TYPE=${{matrix.buildType}} -DREALM_MAX_BPNODE_SIZE=1000 \
                 -DREALM_ASAN=${{matrix.sanitizer == 'address'}} \
                 -DREALM_TSAN=${{matrix.sanitizer == 'thread'}} \
                 -DREALM_USAN=${{matrix.sanitizer == 'undefined'}} \
                 -DREALM_MSAN=${{matrix.sanitizer == 'memory'}}
        cmake --build . --parallel --config ${{matrix.buildType}} 2>&1 | tee build.log

    - name: Scan build log
      if: always()
      uses: ./.github/actions/parse-tool-output
      with:
        log-file-path: ./build/build.log
        tool: clang

    - name: Test
      working-directory: ./build/test
      run: ./realm-tests

  Linux:
    strategy:
      matrix:
        compiler: [gcc, clang]
        buildType: [Debug, Release]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Set up Clang 9
      if: matrix.compiler == 'clang'
      run: |
        sudo update-alternatives --install /usr/bin/cc cc /usr/bin/clang-9 100
        sudo update-alternatives --install /usr/bin/c++ c++ /usr/bin/clang++-9 100

    - name: Install dependencies
      run: |
        sudo apt-get install -y \
            libprocps-dev

    - name: Create build folder
      run: mkdir build

    - name: Build
      working-directory: ./build
      shell: bash
      run: |
        cmake .. -DCMAKE_BUILD_TYPE=${{matrix.buildType}}
        cmake --build . --config ${{matrix.buildType}} --parallel 2>&1 | tee build.log
        cpack -C ${{matrix.buildType}}

    - name: Scan build log
      if: always()
      uses: ./.github/actions/parse-tool-output
      with:
        log-file-path: ./build/build.log
        tool: ${{matrix.compiler}}

    - name: Test
      working-directory: ./build/test
      run: ./realm-tests

    - name: Upload packages
      uses: actions/upload-artifact@v2-preview
      if: matrix.compiler == 'gcc'
      with:
        name: Linux
        path: build/realm-core-*.tar.gz      

  macOS:
    strategy:
      matrix:
        system: [osx, catalyst]
        buildType: [Debug, Release]
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Create build folder
      run: mkdir build

    - name: Build
      working-directory: ./build
      shell: bash
      run: |
        cmake .. -DCMAKE_TOOLCHAIN_FILE=../tools/cmake/mac${{matrix.system}}.toolchain.cmake \
                 -DCMAKE_BUILD_TYPE=${{matrix.buildType}} \
                 -DREALM_BUILD_LIB_ONLY=${{matrix.system == 'catalyst'}}
        cmake --build . --config ${{matrix.buildType}} --parallel 2>&1 | tee build.log
        cpack -C ${{matrix.buildType}}

    - name: Scan build log
      if: always()
      uses: ./.github/actions/parse-tool-output
      with:
        log-file-path: ./build/build.log
        tool: clang

    - name: Test
      if: matrix.system == 'osx'
      working-directory: ./build/test
      run: ./realm-tests

    - name: Upload packages
      uses: actions/upload-artifact@v2-preview
      with:
        name: macOS
        path: build/realm-core-*.tar.gz

  Windows:
    strategy:
      matrix:
        platform: [Win32, x64, ARM, ARM64]
        system:
          - { name: Windows, version: "8.1" }
          - { name: WindowsStore, version: "10.0" }
        buildType: [Debug, Release]
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Create build folder
      run: mkdir build

    - name: Build
      working-directory: ./build
      shell: bash
      run: |
        cmake .. -A ${{matrix.platform}} \
                 -DCMAKE_BUILD_TYPE=${{matrix.buildType}} \
                 -DCMAKE_SYSTEM_NAME=${{matrix.system.name}} \
                 -DCMAKE_SYSTEM_VERSION="${{matrix.system.version}}" \
                 -DCPACK_SYSTEM_NAME="${{matrix.system.name}}-${{matrix.platform}}"
        cmake --build . --config ${{matrix.buildType}} 2>&1 | tee build.log
        # we cannot use cpack here because it conflicts with chocolatey-pack
        cmake --build . --config ${{matrix.buildType}} --target package

    - name: Scan build log
      if: always()
      uses: ./.github/actions/parse-tool-output
      with:
        log-file-path: ./build/build.log
        tool: msvc

    - name: Test
      if: matrix.system.name == 'Windows' && !startsWith(matrix.platform, 'ARM')
      working-directory: ./build/test/${{matrix.buildType}}
      run: .\realm-tests.exe

    - name: Upload packages
      uses: actions/upload-artifact@v2-preview
      with:
        name: Windows
        path: build/realm-core-*.tar.gz

  Android:
    strategy:
      matrix:
        abi: [armeabi-v7a, x86, x86_64, arm64-v8a]
        buildType: [Debug, Release]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - uses: llvm/actions/install-ninja@master

    - name: Build
      shell: bash
      run: |
        export ANDROID_NDK="$ANDROID_SDK_ROOT/ndk-bundle"
        ./tools/cross_compile.sh -o android -a ${{matrix.abi}} -t ${{matrix.buildType}} 2>&1 | tee build.log

    - name: Scan build log
      if: always()
      uses: ./.github/actions/parse-tool-output
      with:
        log-file-path: ./build.log
        tool: clang

    - name: Test
      uses: reactivecircus/android-emulator-runner@v2
      if: startsWith(matrix.abi, 'x86')
      with:
        arch: ${{matrix.abi}}
        api-level: 21
        script: |
          adb shell 'rm -f /data/local/tmp/unit-test-report.xml'
          adb push build-android-${{matrix.abi}}-${{matrix.buildType}}/test/realm-tests /data/local/tmp
          find build-android-${{matrix.abi}}-${{matrix.buildType}}/test -type f -name "*.json" -maxdepth 1 -exec adb push {} /data/local/tmp \;
          find build-android-${{matrix.abi}}-${{matrix.buildType}}/test -type f -name "*.realm" -maxdepth 1 -exec adb push {} /data/local/tmp \;
          find build-android-${{matrix.abi}}-${{matrix.buildType}}/test -type f -name "*.txt" -maxdepth 1 -exec adb push {} /data/local/tmp \;
          adb shell 'cd /data/local/tmp; UNITTEST_PROGRESS=1 GITHUB_ACTIONS=1 ./realm-tests'
          adb pull /data/local/tmp/unit-test-report.xml

    - name: Upload packages
      uses: actions/upload-artifact@v2-preview
      with:
        name: Android
        path: build-android-${{matrix.abi}}-${{matrix.buildType}}/realm-core-*.tar.gz

  AppleDevice:
    strategy:
      matrix:
        system: [iOS, watchOS, tvOS]
        buildType: [MinSizeDebug, Release]
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive

    - name: Build
      shell: bash
      run: |
        ./tools/cross_compile.sh -t ${{matrix.buildType}} -o ${{matrix.system}} 2>&1 | tee build.log

    - name: Scan build log
      if: always()
      uses: ./.github/actions/parse-tool-output
      with:
        log-file-path: ./build.log
        tool: clang

    - name: Upload packages
      uses: actions/upload-artifact@v2-preview
      with:
        name: ${{matrix.system}}
        path: build-${{matrix.system}}-${{matrix.buildType}}/realm-core-*.tar.gz